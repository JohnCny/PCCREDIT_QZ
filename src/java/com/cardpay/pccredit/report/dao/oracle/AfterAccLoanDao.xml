<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cardpay.pccredit.report.dao.AfterAccLoanDao">
	<resultMap id="ResultMap" type="com.cardpay.pccredit.report.model.AccLoanInfo">
	    <result property="rowIndex" column="row_index" />
	    <result property="managerId" column="managerId" />
	    <result property="orgName" column="orgName" />
	    <result property="billNo" column="billNo" />
	    <result property="acctNo" column="acctNo" />
	    <result property="acctName" column="acctName" />
	    <result property="realityIrY" column="realityIrY" />
	    <result property="contStartDate" column="contStartDate" />
	    <result property="contEndDate" column="contEndDate" />
	    <result property="contAmt" column="contAmt" />
	    <result property="loanAmt" column="loanAmt" />
	    <result property="loanBalance" column="loanBalance" />
	    <result property="intAccum" column="intAccum" />
	    <result property="qixiDate" column="qixiDate" />
	    <result property="distrDate" column="distrDate" />
	    <result property="settlDate" column="settlDate" />
	    <result property="accStatus" column="accStatus" />
	    <result property="productId" column="productId" />
	    <result property="clientName" column="clientName" />
	    <result property="productName" column="productName" />
	 </resultMap>
	 
	<resultMap id="OverResultMap" type="com.cardpay.pccredit.report.model.AccLoanOverdueInfo">
	    <result property="rowIndex" column="row_index" />
	    <result property="managerId" column="managerId" />
	    <result property="orgName" column="orgName" />
	    <result property="billNo" column="billNo" />
	    <result property="acctName" column="acctName" />
	    <result property="realityIrY" column="realityIrY" />
	    <result property="contStartDate" column="contStartDate" />
	    <result property="contEndDate" column="contEndDate" />
	    <result property="contAmt" column="contAmt" />
	    <result property="loanAmt" column="loanAmt" />
	    <result property="loanBalance" column="loanBalance" />
	    <result property="intAccum" column="intAccum" />
	    <result property="qixiDate" column="qixiDate" />
	    <result property="distrDate" column="distrDate" />
	    <result property="accStatus" column="accStatus" />
	    <result property="clientName" column="clientName" />
	    <result property="overdueMoney" column="overdueMoney" />
	    <result property="overdue" column="overdue" />
	    <result property="overdueBalance" column="overdueBalance" />
	    <result property="overdueDayCnt" column="overdueDayCnt" />
	 </resultMap>
	 
	<resultMap id="CollectResultMap" type="com.cardpay.pccredit.report.model.AccLoanCollectInfo">
	    <result property="rowIndex" column="rowindex" />
	    <result property="increaseLoancount" column="newUsedLoans" />
	    <result property="loanCustomerSum" column="allLoans" />
	    <result property="increaseCusSum" column="newCreditLoans" />
	    <result property="centreLoansSun" column="allCreditLoans" />
	    <result property="loanBalanceSum" column="loanBalanceSum" />
	    <result property="contAmt" column="contAmt" />
	    <result property="contBalace" column="contBalace" />
	    <result property="increaseLoanCredit" column="newCreditMoney" />
	    <result property="increaseBalanceTheMonth" column="newUsedAge" />
	    <result property="overdueBalanceTheMon" column="overdueBalance" />
	    <result property="overdueBalance" column="overdueBalanceCount" />
	    <result property="increseOverdueCusTheMon" column="newoverdue" />
	    <result property="alloverdue" column="alloverdue" />
	    <result property="resvIntAccum" column="resvIntAccum" />
	    <result property="overdueCusM0" column="M0" />
	    <result property="overdueCusM1" column="M1" />
	    <result property="overdueCusM2" column="M2" />
	    <result property="overdueCusM3" column="M3" />
	    <result property="overdueCusM4" column="M4" />
	 </resultMap>
	 
	 <resultMap id="CollectResultMapNew" type="com.cardpay.pccredit.report.model.AccLoanCollectInfoNew">
	    <result property="rowIndex" column="rowindex" />
	    <result property="value_1_1_start" column="value_1_1_start" />
	    <result property="value_1_1_end" column="value_1_1_end" />
		<result property="value_1_2_start" column="value_1_2_start" />
		<result property="value_1_2_end" column="value_1_2_end" />
		<result property="value_2_1" column="value_2_1" />
		<result property="value_2_2" column="value_2_2" />
		<result property="value_3_1" column="value_3_1" />
		<result property="value_3_2" column="value_3_2" />
		<result property="value_4_2" column="value_4_2" />
		<result property="value_5_1" column="value_5_1" />
		<result property="value_5_2_start" column="value_5_2_start" />
		<result property="value_5_2_end" column="value_5_2_end" />
		<result property="value_5_3_start" column="value_5_3_start" />
		<result property="value_5_3_end" column="value_5_3_end" />
		<result property="value_6_3" column="value_6_3" />
		<result property="value_7_1_start" column="value_7_1_start" />
		<result property="value_7_1_end" column="value_7_1_end" />
		<result property="value_7_2_start" column="value_7_2_start" />
		<result property="value_7_2_end" column="value_7_2_end" />
		<result property="value_8_1" column="value_8_1" />
		<result property="value_8_2" column="value_8_2" />
		<result property="value_8_3" column="value_8_3" />
		<result property="value_8_4" column="value_8_4" />
		<result property="value_9_1" column="value_9_1" />
		<result property="value_9_2" column="value_9_2" />
		<result property="value_10_1_start" column="value_10_1_start" />
		<result property="value_10_1_end" column="value_10_1_end" />
		<result property="value_10_2_start" column="value_10_2_start" />
		<result property="value_10_2_end" column="value_10_2_end" />
		<result property="value_11_1" column="value_11_1" />
		<result property="value_11_2" column="value_11_2" />
		<result property="value_11_3" column="value_11_3" />
	 </resultMap>
	 
	<resultMap id="PsNormIntAmtResultMap" type="com.cardpay.pccredit.report.model.PsNormIntAmt">
	    <result property="id" column="id" />
	    <result property="rowIndex" column="row_index" />
	    <result property="psTime" column="pstime" />
	    <result property="ps_norm_int_amt" column="ps_norm_int_amt" />
	    <result property="ps_od_int_amt" column="ps_od_int_amt" />
	    <result property="setl_norm_int" column="setl_norm_int" />
	    <result property="setl_od_int_amt" column="setl_od_int_amt" />
	    <result property="ps_amt" column="ps_amt" />
	    <result property="cus_id" column="cus_id" />
	    <result property="client_name" column="client_name" />
	 </resultMap>
	 
	 <resultMap id="ResultMapTips" type="com.cardpay.pccredit.report.model.HomeTips">
		<result property="clientName" column="clientName" />
		<result property="psAmt" column="psAmt" />
		<result property="setlAmt" column="setlAmt" />
		<result property="ownAmt" column="ownAmt" />
	</resultMap>
	
	<select id="getAfterAccLoan" resultMap="ResultMap"
			parameterType="com.cardpay.pccredit.report.filter.OClpmAccLoanFilter">
	    
	    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved')

	    SELECT * FROM
			(SELECT ROW_.*,ROWNUM row_index
			FROM (
	    select 
			circle.managerId,
	circle.orgName,
       		loan.bill_no as billNo,
	  		circle.chinese_name as acctName,
       		loan.REALITY_IR_Y as realityIrY,
       		circle.START_DATE as contStartDate,
       		circle.END_DATE as contEndDate,
       		cont.CONT_AMT as contAmt,
       		loan.LOAN_AMT as loanAmt,
       		loan.LOAN_BALANCE as loanBalance,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as intAccum,
       		loan.DISTR_DATE as qixiDate,
       		loan.ORI_END_DATE as distrDate,
       		loan.ACC_STATUS as accStatus,
       		circle.PRODUCT_ID as productId,
       		circle.product_name as productName,
       		circle.chinese_name as clientName
  		from O_CLPM_ACC_LOAN_HISTORY loan
  		left join circle on loan.cont_no = circle.RET_CONTNO
  		left join O_CLPM_CTR_LOAN_CONT cont on loan.cont_no = cont.cont_no
 	  where 1 = 1
  		and  (loan.prd_id='100084' or loan.prd_id='100085')
  		and to_date(loan.data_dt,'yyyy-mm-dd') = #{endDate}
  		<if test="userId != null and userId != '' ">
			and circle.manager_id = #{userId}
 		</if>
 		<if test="orgId != null and orgId != '' ">
			and circle.regist_org_no = #{orgId}
 		</if>
 		<if test="clientName != null and clientName != '' ">
			and circle.chinese_name = #{clientName}
 		</if>
 		<if test="productId != null and productId != '' ">
			and circle.PRODUCT_ID = #{productId}
 		</if>
order by circle.managerId
 		<![CDATA[		
				) ROW_
			WHERE ROWNUM <= #{limit}*#{page} + #{limit}) 
		WHERE row_index > #{limit}*#{page}
		]]>
	</select>
	
	<select id="getAfterAccLoanCount" resultType="int"
			parameterType="com.cardpay.pccredit.report.filter.OClpmAccLoanFilter">
 		
	    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved')

 		SELECT count(*)
			FROM (
	    select 
			circle.managerId,
	circle.orgName,
       		loan.bill_no as billNo,
	  		circle.chinese_name as acctName,
       		loan.REALITY_IR_Y as realityIrY,
       		circle.START_DATE as contStartDate,
       		circle.END_DATE as contEndDate,
       		cont.CONT_AMT as contAmt,
       		loan.LOAN_AMT as loanAmt,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as intAccum,
       		loan.DISTR_DATE as qixiDate,
       		loan.ORI_END_DATE as distrDate,
       		loan.ACC_STATUS as accStatus,
       		circle.chinese_name as clientName
  		from O_CLPM_ACC_LOAN_history loan
  		left join circle on loan.cont_no = circle.RET_CONTNO
  		left join O_CLPM_CTR_LOAN_CONT cont on loan.cont_no = cont.cont_no
 	  where 1 = 1
  		and  (loan.prd_id='100084' or loan.prd_id='100085')
  		and to_date(loan.data_dt,'yyyy-mm-dd') = #{endDate}
  		<if test="userId != null and userId != '' ">
			and circle.manager_id = #{userId}
 		</if>
 		<if test="orgId != null and orgId != '' ">
			and circle.regist_org_no = #{orgId}
 		</if>
 		<if test="clientName != null and clientName != '' ">
			and circle.chinese_name = #{clientName}
 		</if>
 		<if test="productId != null and productId != '' ">
			and circle.PRODUCT_ID = #{productId}
 		</if>

order by circle.managerId
 		) ROW_
   </select>		
	<select id="getLoanOverdue" resultMap="OverResultMap"
			parameterType="com.cardpay.pccredit.report.filter.OClpmAccLoanFilter">
 		
	    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved')
	    
	    SELECT * FROM
			(SELECT ROW_.*,ROWNUM row_index
			FROM (
	    select 
			circle.managerId,
	circle.orgName,
       		loan.bill_no as billNo,
       		
	  		circle.chinese_name as acctName,
       		loan.REALITY_IR_Y as realityIrY,
       		circle.START_DATE as contStartDate,
       		circle.END_DATE as contEndDate,
       		cont.CONT_AMT as contAmt,
       		loan.LOAN_BALANCE as loanBalance,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as intAccum,
       		loan.DISTR_DATE as qixiDate,
       		loan.ORI_END_DATE as distrDate,
       		loan.ACC_STATUS as accStatus,
       		circle.chinese_name as clientName,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as overdueMoney,
       		loan.overdue as overdue,
       		loan.overdue_balance as overdueBalance,
       		to_date(loan.DATA_DT,'yyyy-mm-dd')-to_date(nvl(loan.OVERDUE_DATE,loan.DATA_DT),'yyyy-mm-dd') as overdueDayCnt
  		from O_CLPM_ACC_LOAN_HISTORY loan
  		left join circle on loan.cont_no = circle.RET_CONTNO
  		left join O_CLPM_CTR_LOAN_CONT cont on loan.cont_no = cont.cont_no
 	  where 1 = 1
  		and to_date(loan.DATA_DT,'yyyy-mm-dd') = #{endDate}
  		and loan.prd_id in('100084','100085')
  		and OVERDUE_BALANCE >0
  		and loan.CONT_NO in (select lmt_cont_no from O_CCH_LM_LMT_CONT_T)
      <if test="userId != null and userId != '' ">
			and circle.manager_id = #{userId}
 		</if>
     <if test="orgId != null and orgId != '' ">
      and circle.regist_org_no = #{orgId}
     </if>
     <if test="clientName != null and clientName != '' ">
      and circle.chinese_name = #{clientName}
     </if>

order by circle.managerId
     <![CDATA[		
				) ROW_
			WHERE ROWNUM <= #{limit}*#{page} + #{limit}) 
		WHERE row_index > #{limit}*#{page}
		]]>
 	</select>
 		<select id="getLoanOverdueCount" resultType="int"
			parameterType="com.cardpay.pccredit.report.filter.OClpmAccLoanFilter">
 		
	    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved')
	    
	    SELECT count(*)
			FROM (
	    select
			circle.managerId,
	circle.orgName,
       		loan.bill_no as billNo,
       		
	  		circle.chinese_name as acctName,
       		loan.REALITY_IR_Y as realityIrY,
       		circle.START_DATE as contStartDate,
       		circle.END_DATE as contEndDate,
       		cont.CONT_AMT as contAmt,
       		loan.LOAN_BALANCE as loanBalance,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as intAccum,
       		loan.DISTR_DATE as qixiDate,
       		loan.ORI_END_DATE as distrDate,
       		loan.ACC_STATUS as accStatus,
       		circle.chinese_name as clientName,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as overdueMoney,
       		loan.overdue as overdue,
       		loan.overdue_balance as overdueBalance,
       		to_date(loan.DATA_DT,'yyyy-mm-dd')-to_date(nvl(loan.OVERDUE_DATE,loan.DATA_DT),'yyyy-mm-dd') as overdueDayCnt
  		from O_CLPM_ACC_LOAN_HISTORY loan
  		left join circle on loan.cont_no = circle.RET_CONTNO
  		left join O_CLPM_CTR_LOAN_CONT cont on loan.cont_no = cont.cont_no
 	  where 1 = 1
  		and to_date(loan.DATA_DT,'yyyy-mm-dd') = #{endDate}
  		and loan.prd_id in('100084','100085')
  		and OVERDUE_BALANCE >0
  		and loan.CONT_NO in (select lmt_cont_no from O_CCH_LM_LMT_CONT_T)
      <if test="userId != null and userId != '' ">
			and circle.manager_id = #{userId}
 		</if>
     <if test="orgId != null and orgId != '' ">
      and circle.regist_org_no = #{orgId}
     </if>
     <if test="clientName != null and clientName != '' ">
      and circle.chinese_name = #{clientName}
     </if>

order by circle.managerId
     ) ROW_
 	</select>
 	<select id="getLoanOverdueAll" resultMap="OverResultMap"
			parameterType="com.cardpay.pccredit.report.filter.OClpmAccLoanFilter">
 		
	    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved')
	    
	    select 
			circle.managerId,
	circle.orgName,
       		loan.bill_no as billNo,
       		
	  		circle.chinese_name as acctName,
       		loan.REALITY_IR_Y as realityIrY,
       		circle.START_DATE as contStartDate,
       		circle.END_DATE as contEndDate,
       		cont.CONT_AMT as contAmt,
       		loan.LOAN_BALANCE as loanBalance,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as intAccum,
       		loan.DISTR_DATE as qixiDate,
       		loan.ORI_END_DATE as distrDate,
       		loan.ACC_STATUS as accStatus,
       		circle.chinese_name as clientName,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as overdueMoney,
       		loan.overdue as overdue,
       		loan.overdue_balance as overdueBalance,
       		to_date(loan.DATA_DT,'yyyy-mm-dd')-to_date(nvl(loan.OVERDUE_DATE,loan.DATA_DT),'yyyy-mm-dd') as overdueDayCnt
  		from O_CLPM_ACC_LOAN_HISTORY loan
  		left join circle on loan.cont_no = circle.RET_CONTNO
  		left join O_CLPM_CTR_LOAN_CONT cont on loan.cont_no = cont.cont_no
 	  where 1 = 1
  		and to_date(loan.DATA_DT,'yyyy-mm-dd') = #{endDate}
  		and loan.prd_id in('100084','100085')
  		and OVERDUE_BALANCE >0
  		and loan.CONT_NO in (select lmt_cont_no from O_CCH_LM_LMT_CONT_T)
      <if test="userId != null and userId != '' ">
			and circle.manager_id = #{userId}
 		</if>
     <if test="orgId != null and orgId != '' ">
      and circle.regist_org_no = #{orgId}
     </if>
     <if test="clientName != null and clientName != '' ">
      and circle.chinese_name = #{clientName}
     </if>

order by circle.managerId
 	</select>
 	
	<select id="getAccLoanCollect" resultMap="CollectResultMap"
			parameterType="com.cardpay.pccredit.report.filter.AccLoanCollectFilter">

with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
where CAI.STATUS = 'approved')

select t1.*,
       t2.*,
       t3.*,
       t4.*,
       t5.*,
       t6.*,
       t7.*,
       t8.*,
       t9.*,
       t10.*,
       t11.*,
       t12.*,
       t13.*,
       t14.*,
       t15.*,
       t16.*,
       t17.*,
       t18.*,
       t19.*,
       rownum rowindex
  FROM 
  (select count(laons.CUS_ID) as newUsedLoans
  from (select loan.CUS_ID,min(loan.distr_date)
               from o_clpm_acc_loan loan
               left join circle on loan.cont_no = circle.ret_contno
               
                where 1=1
                and loan.distr_date <![CDATA[ <=  ]]> #{endDate}
                and loan.distr_date <![CDATA[ >=  ]]> #{startDate}
              <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
                </if>
                <if test="userId != null and userId != '' ">
                  and circle.user_id =#{userId}
                </if>   
                <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if>     
               and  (loan.prd_id='100084' or loan.prd_id='100085') 
              group by loan.CUS_ID)  laons ) t1,
 (select count(laons.CUS_ID) as allLoans
  from (select loan.CUS_ID
               from o_clpm_acc_loan loan
               left join circle on loan.cont_no = circle.ret_contno
               
                where 1=1
                and loan.distr_date <![CDATA[ <=  ]]> #{endDate}
              <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
                </if>
                <if test="userId != null and userId != '' ">
                  and circle.user_id =#{userId}
                </if> 
                <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if>        
               and  (loan.prd_id='100084' or loan.prd_id='100085') 
              group by loan.CUS_ID)  laons ) t2,
 (select count(laons.CUS_ID) as newCreditLoans
 from (select cont.CUS_ID
          from o_clpm_ctr_loan_cont cont
          left join circle on cont.cont_no = circle.ret_contno
         where cont.cont_start_date <![CDATA[ <=  ]]> #{endDate}
           and cont.cont_start_date <![CDATA[ >=  ]]> #{startDate}
           and (cont.prd_id='100084' or cont.prd_id='100085')
            <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
            </if>
            <if test="userId != null and userId != '' ">
                and circle.user_id =#{userId}
            </if>
            <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> 
            group by cont.CUS_ID)  laons) t3,
 (select count(laons.CUS_ID) as allCreditLoans
 from (select cont.CUS_ID
          from o_clpm_ctr_loan_cont cont
          left join circle on cont.cont_no = circle.ret_contno
         where cont.cont_start_date <![CDATA[ <=  ]]> #{endDate}
         and (cont.prd_id='100084' or cont.prd_id='100085')
            <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
            </if>
            <if test="userId != null and userId != '' ">
                and circle.user_id =#{userId}
            </if>
            <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> 
            group by cont.CUS_ID)  laons) t4,
 (select sum(loan.LOAN_BALANCE) as loanBalanceSum
          from o_clpm_acc_loan loan
               left join circle on loan.cont_no = circle.ret_contno
         where loan.DISTR_DATE <![CDATA[ <=  ]]> #{endDate}
           and loan.DISTR_DATE <![CDATA[ >=  ]]> #{startDate}
           and (loan.SETTL_DATE is null or loan.SETTL_DATE <![CDATA[ >  ]]> #{endDate})
           and (loan.prd_id='100084' or loan.prd_id='100085')
            <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
            </if>
            <if test="userId != null and userId != '' ">
                and circle.user_id =#{userId}
            </if>
            <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) t5,
 (select sum(cont.LMT_AMT) as contAmt
                          from O_CCH_LM_LMT_CONT_T cont
                          left join circle on cont.LMT_CONT_NO = circle.ret_contno
                         where 1=1
                           and cont.LMT_END_DT <![CDATA[ >  ]]> #{endDate}
                           and (cont.APPLY_TYPE = '01')
                            <if test="productId != null and productId != '' ">
		                      and circle.product_id = #{productId}
		                       </if>
                       <if test="userId != null and userId != '' ">
                        and circle.user_id =#{userId}
                    </if>
                    <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) t6,
 (select sum(loan.loan_balance) as contBalace
                          from o_clpm_acc_loan loan
                          left join circle on loan.cont_no = circle.ret_contno
                         where loan.distr_date <![CDATA[ <=  ]]> #{endDate}
                           and (loan.SETTL_DATE is null or loan.SETTL_DATE <![CDATA[ >  ]]> #{endDate})
                           and (loan.prd_id='100084' or loan.prd_id='100085')
                            <if test="productId != null and productId != '' ">
                        and circle.product_id = #{productId}
                       </if>
                       <if test="userId != null and userId != '' ">
                        and circle.user_id =#{userId}
                    </if>
                    <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) t7,
 (select sum(cont.LMT_AMT) as newCreditMoney
          from O_CCH_LM_LMT_CONT_T cont
          left join circle on cont.LMT_CONT_NO = circle.ret_contno
         where cont.LMT_START_DT <![CDATA[ <=  ]]> #{endDate}
           and cont.LMT_START_DT <![CDATA[ >=  ]]> #{startDate}
           and cont.LMT_END_DT <![CDATA[ >  ]]> #{endDate}
           and (cont.APPLY_TYPE='01')
            <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
            </if>
            <if test="userId != null and userId != '' ">
                and circle.user_id =#{userId}
            </if>
            <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) t8,
 (select sum(balance) / count(data_dt) as newUsedAge
          from (select sum(his.loan_balance) balance, data_dt
                  from o_clpm_acc_loan_history his
                  left join circle on his.cont_no = circle.ret_contno
                 where his.data_dt <![CDATA[ <=  ]]> #{endDate}
                   and his.data_dt <![CDATA[ >=  ]]> #{startDate}
                   and (his.SETTL_DATE is null or his.SETTL_DATE <![CDATA[ >  ]]> his.data_dt)
                   and (his.prd_id='100084' or his.prd_id='100085')
                    <if test="productId != null and productId != '' ">
                    and circle.product_id = #{productId}
                    </if>
                    <if test="userId != null and userId != '' ">
                    and circle.user_id =#{userId}
                </if>
                <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> 
                 group by data_dt)) t9,
 (select sum(loan.overdue_balance) as overdueBalance
          from o_clpm_acc_loan loan
          left join circle on loan.cont_no = circle.ret_contno
         where loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
           and loan.OVERDUE_DATE <![CDATA[ >=  ]]> #{startDate}
           and (loan.prd_id='100084' or loan.prd_id='100085')
           and (loan.SETTL_DATE is null or loan.SETTL_DATE <![CDATA[ >  ]]> #{endDate})
            <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
            </if>
            <if test="userId != null and userId != '' ">
                and circle.user_id =#{userId}
            </if>
            <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) t10,
 (select sum(loan.overdue_balance) as overdueBalanceCount
          from o_clpm_acc_loan loan
          left join circle on loan.cont_no = circle.ret_contno
         where loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
          and (loan.SETTL_DATE is null or loan.SETTL_DATE <![CDATA[ >  ]]> #{endDate})
         and (loan.prd_id='100084' or loan.prd_id='100085')
            <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
            </if>
            <if test="userId != null and userId != '' ">
                and circle.user_id =#{userId}
            </if>
            <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) t11,
 (select count(loans.cus_id) as newoverdue
          from (select loan.cus_id
                  from o_clpm_acc_loan_history loan
                  left join circle on loan.cont_no = circle.ret_contno
                 where loan.OVERDUE_DATE <![CDATA[ >=  ]]> #{startDate}
                   and loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
                   and (loan.prd_id='100084' or loan.prd_id='100085')
                    <if test="productId != null and productId != '' ">
                    and circle.product_id = #{productId}
                   </if>
                   <if test="userId != null and userId != '' ">
                  and circle.user_id =#{userId}
                 </if>
                 <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> 
                 group by loan.cus_id) loans) t12,
 (select count(loans.cus_id) as alloverdue
          from (select loan.cus_id
                  from o_clpm_acc_loan_history loan
                  left join circle on loan.cont_no = circle.ret_contno
                 where loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
                   and (loan.prd_id='100084' or loan.prd_id='100085')
                    <if test="productId != null and productId != '' ">
                    and circle.product_id = #{productId}
                   </if>
                   <if test="userId != null and userId != '' ">
                  and circle.user_id =#{userId}
                 </if>
                 <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> 
                 group by loan.cus_id) loans) t13,
 (select sum(his.recv_int_accum) as resvIntAccum
          from o_clpm_acc_loan_history his
          left join circle on his.cont_no = circle.ret_contno
         where his.data_dt <![CDATA[ =  ]]> #{endDate}
           and (his.prd_id='100084' or his.prd_id='100085')
            <if test="productId != null and productId != '' ">
                and circle.product_id = #{productId}
            </if>
            <if test="userId != null and userId != '' ">
                and circle.user_id =#{userId}
            </if>
            <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) t14,
 (select count(*) as M0
          from (select a.cus_id
                  from (select loan.*
                          from o_clpm_acc_loan_history loan
                          left join circle on loan.cont_no = circle.ret_contno
                         where loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
                          and (loan.prd_id='100084' or loan.prd_id='100085')
                            <if test="productId != null and productId != '' ">
                        and circle.product_id = #{productId}
                       </if>
                           and loan.overdue = 0
                           <if test="userId != null and userId != '' ">
                      and circle.user_id =#{userId}
                     </if>
                     <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) a
                 group by a.cus_id)) t15,
 (select count(*) as M1
          from (select a.cus_id
                  from (select loan.*
                          from o_clpm_acc_loan_history loan
                          left join circle on loan.cont_no = circle.ret_contno
                         where loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
                         and (loan.prd_id='100084' or loan.prd_id='100085')
                            <if test="productId != null and productId != '' ">
                         and circle.product_id = #{productId}
                       </if>
                           and loan.overdue = 1
                           <if test="userId != null and userId != '' ">
                      and circle.user_id =#{userId}
                     </if>
                     <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) a
                 group by a.cus_id)) t16,                
 (select count(*) as M2
          from (select a.cus_id
                  from (select loan.*
                          from o_clpm_acc_loan_history loan
                          left join circle on loan.cont_no = circle.ret_contno
                         where loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
                         and (loan.prd_id='100084' or loan.prd_id='100085')
                           <if test="productId != null and productId != '' ">
                        and circle.product_id = #{productId}
                       </if>
                           and loan.overdue = 2
                           <if test="userId != null and userId != '' ">
                      and circle.user_id =#{userId}
                     </if>
                     <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) a
                 group by a.cus_id)) t17,
 (select count(*) as M3
          from (select a.cus_id
                  from (select loan.*
                          from o_clpm_acc_loan_history loan
                          left join circle on loan.cont_no = circle.ret_contno
                         where loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
                         and (loan.prd_id='100084' or loan.prd_id='100085')
                            <if test="productId != null and productId != '' ">
                        and circle.product_id = #{productId}
                       </if>
                           and loan.overdue = 3
                           <if test="userId != null and userId != '' ">
                      and circle.user_id =#{userId}
                     </if>
                     <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) a
                 group by a.cus_id)) t18,
 (select count(*) as M4
          from (select a.cus_id
                  from (select loan.*
                          from o_clpm_acc_loan_history loan
                          left join circle on loan.cont_no = circle.ret_contno
                         where loan.OVERDUE_DATE <![CDATA[ <=  ]]> #{endDate}
                         and (loan.prd_id='100084' or loan.prd_id='100085')
                            <if test="productId != null and productId != '' ">
                          and circle.product_id = #{productId}
                       </if>
                           and loan.overdue >= 4
                           <if test="userId != null and userId != '' ">
                      and circle.user_id =#{userId}
                     </if>
                     <if test="filterTeamLeader!=null and filterTeamLeader!=''">
					<if test='filterTeamLeader=="1"'>
						and circle.user_id in ( 
							select user_id from ACCOUNT_MANAGER_PARAMETER where id in (SELECT 
							mbm.child_id 
							FROM 
							manager_belong_map mbm 
							LEFT JOIN account_manager_parameter amp ON amp. ID = mbm.parent_id 
							WHERE 
							amp.user_id = #{loginId})
							union select #{loginId} as user_id from dual)
					</if>
				</if> ) a
                 group by a.cus_id)) t19
 		</select>
 		<select id="getAfterAccLoanByCustomerId" resultMap="ResultMap">
 		    select    loan.bill_no as billNo,
       		loan.REALITY_IR_Y as realityIrY,
       		loan.END_DATE as contEndDate,
       		loan.LOAN_AMT as loanAmt,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as intAccum,
       		loan.DISTR_DATE as qixiDate,
       		loan.ORI_END_DATE as distrDate,
       		loan.ACC_STATUS as accStatus,
       		ecif.client_name as clientName,
       		rownum row_index
  		from o_clpm_acc_loan loan
 		inner join qz_iesb_for_ecif ecif on loan.cus_id = ecif.client_no
 		and ecif.customer_id = #{customerId}
 		</select>
 		
 		<select id="getAfterAccLoanAll" resultMap="ResultMap"
			parameterType="com.cardpay.pccredit.report.filter.OClpmAccLoanFilter">
                           with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved')

	    SELECT ROW_.*,ROWNUM row_index
			FROM (
			
	    select
circle.managerId,
	circle.orgName,
       		loan.bill_no as billNo,
	  		circle.chinese_name as acctName,
       		loan.REALITY_IR_Y as realityIrY,
       		circle.START_DATE as contStartDate,
       		circle.END_DATE as contEndDate,
       		cont.CONT_AMT as contAmt,
       		loan.LOAN_AMT as loanAmt,
       		loan.loan_balance as loanBalance,
       		(loan.Rec_Int_Accum - loan.recv_int_accum) as intAccum,
       		loan.DISTR_DATE as qixiDate,
       		loan.ORI_END_DATE as distrDate,
       		loan.SETTL_DATE as settlDate,
       		loan.ACC_STATUS as accStatus,
       		circle.PRODUCT_ID as product_id,
       		circle.product_name as productName,
       		circle.chinese_name as clientName
  		from O_CLPM_ACC_LOAN_history loan
  		left join circle on loan.cont_no = circle.RET_CONTNO
  		left join O_CLPM_CTR_LOAN_CONT cont on loan.cont_no = cont.cont_no
 	  where 1 = 1
  		and (loan.prd_id='100084' or loan.prd_id='100085')
  		and to_date(loan.data_dt,'yyyy-mm-dd') = #{endDate}
  		<if test="userId != null and userId != '' ">
			and circle.manager_id = #{userId}
 		</if>
 		<if test="orgId != null and orgId != '' ">
			and circle.regist_org_no = #{orgId}
 		</if>
 		<if test="clientName != null and clientName != '' ">
			and circle.chinese_name = #{clientName}
 		</if>	
 		<if test="productId != null and productId != '' ">
			and circle.PRODUCT_ID = #{productId}
 		</if>
 		order by circle.managerId
				) ROW_
	</select>
	
 		<select id="getPsNormIntAmt" resultMap="PsNormIntAmtResultMap">
 		    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved'
				<if test="productId != null and productId != '' ">
                and CAI.product_id = #{productId}
                </if>
                <if test="userIds != null">
                	and circle.user_id in 
                	<foreach item="item" index="index" collection="userIds" open="(" separator="," close=")">
                        #{item}
                	</foreach> 
                </if>)

			 SELECT * FROM
				(SELECT ROW_.*,ROWNUM row_index
				FROM (
			
 		    select 
 		    	to_char(#{endDate},'yyyy-MM-dd') as pstime,sum(PS_NORM_INT_AMT) as PS_NORM_INT_AMT,sum(PS_OD_INT_AMT) as PS_OD_INT_AMT,
 		    	sum(SETL_NORM_INT) as SETL_NORM_INT,sum(SETL_OD_INT_AMT) as SETL_OD_INT_AMT,
 		    	to_number(sum(PS_NORM_INT_AMT))+to_number(sum(PS_OD_INT_AMT))-to_number(sum(SETL_NORM_INT))-to_number(sum(SETL_OD_INT_AMT)) as ps_amt,
 		    	loan.CUS_ID as cus_id,circle.chinese_name as client_name
 		    from O_CLPM_ACC_LOAN loan 
 		    	inner join O_CCH_LM_PM_SHD shd on loan.BILL_NO = shd.LOAN_NO
 		    	inner join circle on loan.CUS_ID = circle.client_no
 		    where 
 		    	loan.prd_id in ('100084','100085')
 		    	and loan.ACC_STATUS = '1'
 		    	and shd.SETL_IND = 'N'
 		    	and to_date(shd.PS_DUE_DT,'yyyy-mm-dd') <![CDATA[ <=  ]]> #{endDate}
 		    group by loan.CUS_ID,circle.chinese_name
 		    <![CDATA[		
				) ROW_
			WHERE ROWNUM <= #{limit}*#{page} + #{limit}) 
		WHERE row_index > #{limit}*#{page}
		]]>
 		</select>
 		
 		<select id="getPsNormIntAmtCount" resultType="int">
 		    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved'
				<if test="productId != null and productId != '' ">
                and CAI.product_id = #{productId}
                </if>
                <if test="userIds != null">
                	and circle.user_id in  
                	<foreach item="item" index="index" collection="userIds" open="(" separator="," close=")">
                        #{item}
                	</foreach> 
                </if>)
				
			select count(*) from (
	 		    select 
	 		    	to_char(#{endDate},'yyyy-MM-dd') as pstime,sum(PS_NORM_INT_AMT) as PS_NORM_INT_AMT,sum(PS_OD_INT_AMT) as PS_OD_INT_AMT,
	 		    	sum(SETL_NORM_INT) as SETL_NORM_INT,sum(SETL_OD_INT_AMT) as SETL_OD_INT_AMT,
	 		    	to_number(sum(PS_NORM_INT_AMT))+to_number(sum(PS_OD_INT_AMT))-to_number(sum(SETL_NORM_INT))-to_number(sum(SETL_OD_INT_AMT)) as ps_amt,
	 		    	loan.CUS_ID as cus_id,circle.chinese_name as client_name
	 		    from O_CLPM_ACC_LOAN loan 
	 		    	inner join O_CCH_LM_PM_SHD shd on loan.BILL_NO = shd.LOAN_NO
	 		    	inner join circle on loan.CUS_ID = circle.client_no
	 		    where 
	 		    	loan.prd_id in ('100084','100085')
	 		    	and loan.ACC_STATUS = '1'
	 		    	and shd.SETL_IND = 'N'
	 		    	and to_date(shd.PS_DUE_DT,'yyyy-mm-dd') <![CDATA[ <=  ]]> #{endDate}
	 		    group by loan.CUS_ID,circle.chinese_name
			)
 		</select>
 		
 		<select id="getPsNormIntAmtList" resultMap="PsNormIntAmtResultMap">
 		    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved'
				<if test="productId != null and productId != '' ">
                and CAI.product_id = #{productId}
                </if>
                <if test="userIds != null">
                	and circle.user_id in 
                	<foreach item="item" index="index" collection="userIds" open="(" separator="," close=")">
                        #{item}
                	</foreach> 
                </if>)

	    SELECT ROW_.*,ROWNUM row_index
			FROM (
			
 		    select 
 		    	to_char(#{endDate},'yyyy-MM-dd') as pstime,sum(PS_NORM_INT_AMT) as PS_NORM_INT_AMT,sum(PS_OD_INT_AMT) as PS_OD_INT_AMT,
 		    	sum(SETL_NORM_INT) as SETL_NORM_INT,sum(SETL_OD_INT_AMT) as SETL_OD_INT_AMT,
 		    	to_number(sum(PS_NORM_INT_AMT))+to_number(sum(PS_OD_INT_AMT))-to_number(sum(SETL_NORM_INT))-to_number(sum(SETL_OD_INT_AMT)) as ps_amt,
 		    	loan.CUS_ID as cus_id,circle.chinese_name as client_name
 		    from O_CLPM_ACC_LOAN loan 
 		    	inner join O_CCH_LM_PM_SHD shd on loan.BILL_NO = shd.LOAN_NO
 		    	inner join circle on loan.CUS_ID = circle.client_no
 		    where 
 		    	loan.prd_id in ('100084','100085')
 		    	and loan.ACC_STATUS = '1'
 		    	and shd.SETL_IND = 'N'
 		    	and to_date(shd.PS_DUE_DT,'yyyy-mm-dd') <![CDATA[ <=  ]]> #{endDate}
 		    group by loan.CUS_ID,circle.chinese_name

				) ROW_
 		</select>
 		
 		<select id="getPsNormIntAmtListForHome" resultMap="ResultMapTips">
	    with circle as (select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved')

	    SELECT ROW_.*,ROWNUM row_index
			FROM (
			
 		    select 
 		    	to_char(#{endDate},'yyyy-MM-dd') as pstime,
 		    	(to_number(sum(PS_NORM_INT_AMT))+to_number(sum(PS_OD_INT_AMT))) as psAmt,
 		    	(to_number(sum(SETL_NORM_INT))+to_number(sum(SETL_OD_INT_AMT))) as setlAmt,
 		    	to_number(sum(PS_NORM_INT_AMT))+to_number(sum(PS_OD_INT_AMT))-to_number(sum(SETL_NORM_INT))-to_number(sum(SETL_OD_INT_AMT)) as ownAmt,
 		    	loan.CUS_ID as cus_id,circle.chinese_name as clientName
 		    from O_CLPM_ACC_LOAN loan 
 		    	inner join O_CCH_LM_PM_SHD shd on loan.BILL_NO = shd.LOAN_NO
 		    	inner join circle on loan.CUS_ID = circle.client_no
 		    where 
 		    	loan.prd_id in ('100084','100085')
 		    	and loan.ACC_STATUS = '1'
 		    	and shd.SETL_IND = 'N'
 		    	and to_date(shd.PS_DUE_DT,'yyyy-mm-dd') <![CDATA[ <=  ]]> #{endDate}
 		    	<if test="userIds != null">
 		    		and circle.user_id in 
                	<foreach item="item" index="index" collection="userIds" open="(" separator="," close=")">
                        #{item}
                	</foreach> 
                </if>
 		    group by loan.CUS_ID,circle.chinese_name

				) ROW_
 		</select>
 		
 		<select id="getAccLoanCollectNew" resultMap="CollectResultMapNew"
			parameterType="com.cardpay.pccredit.report.filter.AccLoanCollectFilter">
			with 
			circle as 
				(select CIRCLE.*,CAI.PRODUCT_ID,bci.user_id as manager_id,pa.product_name ,
sd.name as orgName,su.display_name as managerId,bci.chinese_name
from CUSTOMER_APPLICATION_INFO cai 
left join QZ_IESB_FOR_CIRCLE circle on CAI.id = CIRCLE.APPLICATION_ID
left join BASIC_CUSTOMER_INFORMATION bci on cai.customer_id = bci.id
left join product_attribute pa on CAI.PRODUCT_ID = pa.id
left join sys_user su on circle.user_id = su.id
left join SYS_ORGANIZATION sd on circle.regist_org_no = sd.id
where CAI.STATUS = 'approved'
				<if test="productId != null and productId != '' ">
                and CAI.product_id = #{productId}
                </if>
                <if test="userIds != null">
                	and circle.user_id in  
                	<foreach item="item" index="index" collection="userIds" open="(" separator="," close=")">
                        #{item}
                	</foreach> 
                </if>
                 
				)

		select 
		       t_1_1_start.*,
		       t_1_1_end.*,
		       t_1_2_start.*,
		       t_1_2_end.*,
		       t_2_1.*,
		       t_2_2.*,
		       t_3_1.*,
		       t_3_2.*,
		       t_4_2.*,
		       t_5_1.*,
		       t_5_2_start.*,
		       t_5_2_end.*,
		       t_5_3_start.*,
		       t_5_3_end.*,
		       t_6_3.*,
		       t_7_1_start.*,
		       t_7_1_end.*,
		       t_7_2_start.*,
		       t_7_2_end.*,
		       t_8_1.*,
		       t_8_2.*,
		       t_8_3.*,
		       t_8_4.*,
		       t_9_1.*,
		       t_9_2.*,
		       t_10_1_start.*,
		       t_10_1_end.*,
		       t_10_2_start.*,
		       t_10_2_end.*,
		       t_11_1.*,
		       t_11_2.*,
		       t_11_3.*,
		       rownum rowindex
		  FROM 
		 (select count(CUST_ID) as value_1_1_start
		 from(select CUST_ID
		    from O_CCH_LM_LMT_CONT_T cont
		   where cont.apply_type = '01'
		     and cont.LMT_CONT_NO in (select RET_CONTNO from circle)
		     and cont.LMT_START_DT <![CDATA[ <=  ]]> #{startDate}
		   group by cont.CUST_ID)) t_1_1_start,
		   
		 (select count(CUST_ID) as value_1_1_end
		 from(select CUST_ID
		    from O_CCH_LM_LMT_CONT_T cont
		   where cont.apply_type = '01'
		     and cont.LMT_CONT_NO in (select RET_CONTNO from circle)
		     and cont.LMT_START_DT <![CDATA[ <=  ]]> #{endDate}
		   group by cont.CUST_ID)) t_1_1_end,
		
		 (select sum(cont.LMT_AMT) as value_1_2_start
		    from (select ROW_NUMBER() OVER(PARTITION BY cust_id ORDER BY LMT_END_DT DESC) rn,cont.LMT_AMT
		            from O_CCH_LM_LMT_CONT_T cont
		   where cont.apply_type = '01'
		     and cont.LMT_CONT_NO in (select RET_CONTNO from circle)
		     and cont.LMT_START_DT <![CDATA[ <=  ]]> #{startDate}) cont where rn = 1) t_1_2_start,
		
		 (select sum(cont.LMT_AMT) as value_1_2_end
		    from (select ROW_NUMBER() OVER(PARTITION BY cust_id ORDER BY LMT_END_DT DESC) rn,cont.LMT_AMT
		            from O_CCH_LM_LMT_CONT_T cont
		   where cont.apply_type = '01'
		     and cont.LMT_CONT_NO in (select RET_CONTNO from circle)
		     and cont.LMT_START_DT <![CDATA[ <=  ]]> #{endDate}) cont where rn = 1) t_1_2_end,
		   
		 (select count(CUST_ID) as value_2_1
		  from(select CUST_ID from O_CCH_LM_LMT_CONT_T cont
		   where cont.apply_type = '01'
		     and cont.LMT_CONT_NO in (select RET_CONTNO from circle)
		     and cont.LMT_STS = '10'
		   group by cont.CUST_ID)) t_2_1,
		   
		 (select sum(cont.LMT_AMT) as value_2_2 from O_CCH_LM_LMT_CONT_T cont
		   where cont.apply_type = '01'
		     and cont.LMT_CONT_NO in (select RET_CONTNO from circle) 
		   and cont.LMT_STS = '10') t_2_2,
		     
		  (select count(CUST_ID) as value_3_1 from (select CUST_ID 
        from O_CCH_LM_LMT_CONT_T cont
       where cont.apply_type = '01'
         and cont.LMT_CONT_NO in (select RET_CONTNO from circle)
         and cont.LMT_STS != '10'
         and cont.LMT_CONT_NO in
             (select CONT_NO from O_CLPM_ACC_LOAN loan
       where loan.PRD_ID in ('100084', '100085')
         and loan.CONT_NO in (select RET_CONTNO from circle)
         and loan.ACC_STATUS = '1')
       group by cont.CUST_ID)) t_3_1,
		
		 (select sum(cont.LMT_AMT) as value_3_2
		    from O_CCH_LM_LMT_CONT_T cont
		   where cont.apply_type = '01'
		     and cont.LMT_CONT_NO in (select RET_CONTNO from circle)
		     and cont.LMT_STS != '10'
		     and cont.LMT_CONT_NO in
		         (select CONT_NO from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.ACC_STATUS = '1')) t_3_2,
		
		 (select sum(loan.LOAN_BALANCE) as value_4_2
		    from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.ACC_STATUS = '1') t_4_2,
		
		 (select count(CUS_ID) as value_5_1 from 
       (select CUS_ID from O_CLPM_ACC_LOAN loan
       where loan.PRD_ID in ('100084', '100085')
       and loan.CONT_NO in (select RET_CONTNO from circle)
       and loan.distr_date <![CDATA[ <=  ]]> #{endDate}
       and loan.distr_date <![CDATA[ >=  ]]> #{startDate}
       and loan.CONT_NO in (
       select LMT_CONT_NO from (select ROW_NUMBER() OVER(PARTITION BY cust_id ORDER BY LMT_START_DT asc) rn,LMT_CONT_NO from O_CCH_LM_LMT_CONT_T )
       where rn = 1
       )
       group by loan.CUS_ID
       )) t_5_1,
		
		 (select count(CUS_ID) as value_5_2_start
		  from(select  CUS_ID from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{startDate}
		     and loan_history.ACC_STATUS = '1'
		   group by loan_history.CUS_ID)) t_5_2_start,
		
		 (select count(CUS_ID) as value_5_2_end
		   from(select CUS_ID from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{endDate}
		     and loan_history.ACC_STATUS = '1'
		   group by loan_history.CUS_ID)) t_5_2_end,
		
		 (select sum(loan_history.LOAN_BALANCE) as value_5_3_start
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{startDate}
		     and loan_history.ACC_STATUS = '1') t_5_3_start,
		     
		 (select sum(loan_history.LOAN_BALANCE) as value_5_3_end
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{endDate}
		     and loan_history.ACC_STATUS = '1') t_5_3_end,
		
		 (select sum(loan_history.LOAN_BALANCE) /
		         (to_date(#{endDate}, 'yyyy/mm/dd') - to_date(#{startDate}, 'yyyy/mm/dd')+1) as value_6_3
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt <![CDATA[ <=  ]]> #{endDate}
		     and loan_history.data_dt <![CDATA[ >=  ]]> #{startDate}
		     and loan_history.ACC_STATUS = '1') t_6_3,
		
		 (select count(CUS_ID) as value_7_1_start
		  from(select   CUS_ID from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{startDate}
		     and loan_history.OVERDUE_BALANCE > 0
		   group by loan_history.CUS_ID)) t_7_1_start,
		   
		 (select count(CUS_ID) as value_7_1_end
		   from(select CUS_ID from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{endDate}
		     and loan_history.OVERDUE_BALANCE > 0
		   group by loan_history.CUS_ID)) t_7_1_end,
		
		 (select sum(loan_history.OVERDUE_BALANCE) as value_7_2_start
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{startDate}
		     and loan_history.OVERDUE_BALANCE > 0) t_7_2_start,
		
		 (select sum(loan_history.OVERDUE_BALANCE) as value_7_2_end
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{endDate}
		     and loan_history.OVERDUE_BALANCE > 0) t_7_2_end,
		
		 (select count(CUS_ID) as value_8_1
		   from(select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.overdue = 1
		     and loan.CUS_ID not in (select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle) 
		     and loan.overdue > 1)
		   group by loan.CUS_ID)) t_8_1,
		
		 (select count(CUS_ID) as value_8_2
		   from(select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.overdue = 2
		     and loan.CUS_ID not in (select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		      and loan.overdue > 2)
		   group by loan.CUS_ID)) t_8_2,
		
		 (select count(CUS_ID) as value_8_3
		   from(select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.overdue = 3
		     and loan.CUS_ID not in (select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle) 
		     and loan.overdue > 3)
		   group by loan.CUS_ID)) t_8_3,
		
		 (select count(CUS_ID) as value_8_4
		   from(select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.overdue <![CDATA[ >=  ]]> 4
		   group by loan.CUS_ID)) t_8_4,
		
		 (select count(CUS_ID) as value_9_1
		   from(select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.OVERDUE_BALANCE > 0
		   group by loan.CUS_ID)) t_9_1,
		
		 (select sum(loan.OVERDUE_BALANCE) as value_9_2
		    from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.OVERDUE_BALANCE > 0) t_9_2,
		
		 (select sum(RECV_INT_ACCUM) as value_10_1_start
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{startDate}) t_10_1_start,
		     
		 (select sum(RECV_INT_ACCUM) as value_10_1_end
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{endDate}) t_10_1_end,
		     
		 (select sum(REC_INT_ACCUM) as value_10_2_start
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{startDate}) t_10_2_start,
		
		 (select sum(REC_INT_ACCUM) as value_10_2_end
		     from O_CLPM_ACC_LOAN_HISTORY loan_history
		   where loan_history.PRD_ID in ('100084', '100085')
		     and loan_history.CONT_NO in (select RET_CONTNO from circle)
		     and loan_history.data_dt = #{endDate}) t_10_2_end,
		
		 (select sum(loan.LOAN_BALANCE) as value_11_1
		    from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.OVERDUE_BALANCE > 0) t_11_1,
		
		 (select sum(loan.OVERDUE_BALANCE) as value_11_2
		    from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.OVERDUE_BALANCE > 0) t_11_2,
		
		 (select count(CUS_ID) as value_11_3
		   from(select CUS_ID from O_CLPM_ACC_LOAN loan
		   where loan.PRD_ID in ('100084', '100085')
		     and loan.CONT_NO in (select RET_CONTNO from circle)
		     and loan.distr_date <![CDATA[ <=  ]]> #{endDate}
		     and loan.distr_date <![CDATA[ >=  ]]> #{startDate}
		   group by loan.CUS_ID)) t_11_3
		</select>
	 </mapper>